name: Build and Deploy Guacamole Images

on:
  push:
    branches: [main, master]
  schedule:
    # Run on a schedule (equivalent to GitLab schedules)
    - cron: '0 2 * * 0'  # Weekly on Sunday at 2 AM UTC
  workflow_dispatch:
    inputs:
      component:
        description: 'Component to build'
        required: true
        default: 'both'
        type: choice
        options:
          - server
          - client
          - both
      clear_cache:
        description: 'Clear Docker build cache'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  packages: write

env:
  DOCKER_REGISTRY: registry.mapas.world:5000

jobs:
  # ====================================
  # BUILD GUACAMOLE SERVER
  # ====================================
  build-guacamole-server:
    name: ğŸ—ï¸ Build Guacamole Server
    runs-on: self-hosted
    
    # Only run on schedule or manual dispatch
    if: |
      github.event_name == 'schedule' || 
      github.event_name == 'workflow_dispatch' &&
      (github.event.inputs.component == 'server' || github.event.inputs.component == 'both')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Login to Docker Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ secrets.DOCKER_REGISTRY_USERNAME }}
          password: ${{ secrets.DOCKER_REGISTRY_PASSWORD }}

      - name: ğŸ” Clone Guacamole Server Repository
        run: |
          echo "ğŸ“¦ Cloning the Guacamole Server repository from GitHub"
          git clone https://github.com/apache/guacamole-server.git
          ls -lh
          cd guacamole-server
          echo "âœ… Repository cloned successfully"

      - name: ğŸš€ Build and push Guacamole Server
        working-directory: ./guacamole-server
        run: |
          echo "ğŸ—ï¸ Building the Docker image with buildx for multi-arch (linux/arm64)"
          docker buildx build \
            --platform linux/arm64 \
            -t ${{ env.DOCKER_REGISTRY }}/guacamole-server:latest \
            --pull \
            --push \
            -f Dockerfile \
            ${{ github.event.inputs.clear_cache == 'true' && '--no-cache' || '' }} \
            .
          echo "âœ… Guacamole Server image built and pushed successfully"

  # ====================================
  # BUILD GUACAMOLE CLIENT
  # ====================================
  build-guacamole-client:
    name: ğŸ—ï¸ Build Guacamole Client
    runs-on: self-hosted
    needs: [build-guacamole-server]
    
    # Only run on schedule or manual dispatch, and after server build completes
    if: |
      (github.event_name == 'schedule' || 
       github.event_name == 'workflow_dispatch') &&
      (github.event.inputs.component == 'client' || github.event.inputs.component == 'both' || github.event_name == 'schedule') &&
      (success() || github.event.inputs.component == 'client')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Login to Docker Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ secrets.DOCKER_REGISTRY_USERNAME }}
          password: ${{ secrets.DOCKER_REGISTRY_PASSWORD }}

      - name: ğŸ” Clone Guacamole Client Repository
        run: |
          echo "ğŸ“¦ Cloning the Guacamole Client repository from GitHub"
          git clone https://github.com/apache/guacamole-client
          ls -lh
          cd guacamole-client
          echo "âœ… Repository cloned successfully"

      - name: ğŸš€ Build and push Guacamole Client
        working-directory: ./guacamole-client
        run: |
          echo "ğŸ—ï¸ Building the Docker image with buildx for multi-arch (linux/arm64)"
          docker buildx build \
            --platform linux/arm64 \
            -t ${{ env.DOCKER_REGISTRY }}/guacamole-client:latest \
            --pull \
            --push \
            -f Dockerfile \
            ${{ github.event.inputs.clear_cache == 'true' && '--no-cache' || '' }} \
            .
          echo "âœ… Guacamole Client image built and pushed successfully"

  # ====================================
  # SUMMARY
  # ====================================
  build-summary:
    name: ğŸ“‹ Build Summary
    runs-on: self-hosted
    needs: [build-guacamole-server, build-guacamole-client]
    if: always()
    
    steps:
      - name: ğŸ“Š Display build results
        run: |
          echo "ğŸ¯ Guacamole Build Summary"
          echo "=========================="
          echo ""
          echo "ğŸ—ï¸  Guacamole Server: ${{ needs.build-guacamole-server.result }}"
          echo "ğŸ—ï¸  Guacamole Client: ${{ needs.build-guacamole-client.result }}"
          echo ""
          echo "ğŸ“¦ Images pushed to: ${{ env.DOCKER_REGISTRY }}"
          echo "ğŸ·ï¸  Tags: guacamole-server:latest, guacamole-client:latest"
          echo ""
          if [ "${{ needs.build-guacamole-server.result }}" = "success" ] && [ "${{ needs.build-guacamole-client.result }}" = "success" ]; then
            echo "âœ… All builds completed successfully!"
          else
            echo "âš ï¸ Some builds failed or were skipped"
          fi
